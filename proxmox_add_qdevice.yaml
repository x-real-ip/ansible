---
- name: Play to add odroid as qdevice
  hosts: proxmox:odroid
  gather_facts: true
  become: true
  strategy: linear
  tasks:
    - name: Install corosync-qdevice and dependencies
      ansible.builtin.apt:
        update_cache: true
        name:
          - corosync-qdevice
          - python3-pip
        state: present
      when: ansible_hostname != "odroid-c4"

    - name: Install pexpect
      ansible.builtin.pip:
        name: pexpect
      when: ansible_hostname != "odroid-c4"

    # - name: Add Qdevice and except fingerprint
    #   ansible.builtin.expect:
    #     command: pvecm qdevice setup {{ hostvars['odroid-c4.lan']['ansible_eth0']['ipv4']['address'] }} -f
    #     echo: true
    #     timeout: 20
    #     responses:
    #       "Are you sure you want to continue connecting (yes/no/[fingerprint])?": "yes"

    # - name: Except SSH odroid-c4 fingerprint
    #   ansible.builtin.expect:
    #     echo: true
    #     timeout: 20
    #     command: pvecm qdevice setup {{ hostvars['odroid-c4.lan']['ansible_eth0']['ipv4']['address'] }} -f
    #     responses:
    #       "Are you sure you want to continue connecting (yes/no/[fingerprint])?": "yes"
    #       "password: ": "{{ password }}"

    - name: Put SSH public key in variable
      ansible.builtin.command: cat ~/.ssh/id_rsa.pub
      register: pve_a_pubkey
      changed_when: pve_a_pubkey.rc != 0
      delegate_to: pve-a
      run_once: true

    - name: Add a line to a file if the file does not exist, without passing regexp
      ansible.builtin.lineinfile:
        path: "/home/odroid/.ssh/authorized_keys.bak"
        line: "{{ pve_a_pubkey.stdout }}"
        create: true
      when: ansible_hostname == "odroid-c4"
