---
- name: Read kube-vip template file and apply to the k3s cluster
  kubernetes.core.k8s:
    state: present
    template: "kube-vip.yaml.j2"
  run_once: true

- name: Wait until all kube-vip pods are running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: kube-system
    label_selectors:
      - "name = kube-vip-ds"
  register: pod_list
  until: pod_list | json_query('resources[*].status.phase') | unique == ["Running"]
  retries: 15
  delay: 3
  run_once: true
