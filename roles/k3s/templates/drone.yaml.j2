---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-iscsi-{{ drone.name }}-server-data
spec:
  storageClassName: "freenas-iscsi-manual-csi"
  capacity:
    storage: 8Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: xfs
    volumeHandle: pv-iscsi-{{ drone.name }}-server-data
    volumeAttributes:
      portal: storage-server-lagg.lan:3260
      iqn: iqn.2005-10.org.freenas.ctl:{{ drone.name }}-server-data
      lun: "0"
      node_attach_driver: iscsi
      provisioner_driver: node-manual

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-iscsi-{{ drone.name }}-server-data
  namespace: {{ drone.namespace }}
  annotations:
    volume.beta.kubernetes.io/storage-class: "freenas-iscsi-manual-csi"
spec:
  storageClassName: freenas-iscsi-manual-csi
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 8Gi
  volumeName: pv-iscsi-{{ drone.name }}-server-data

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: github-ssh-keys
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    id_rsa: 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
    id_rsa.pub: AgAyrKKoHc+9Eskv9ZceFjQeia3ND7yv76l/VO2UuNVGlCn5kWllYVO1HRvhkl/7EdZBZwRJEo6hCQod2tCJYScHfhE9dV58TV9xKTUJjxR6lXrov4tvzaQ/LkNRHhJbTp/0k9EzzZ9nY9dYGRetV9eqITy17SSgwyLHxwo/7oKt+yV6CefN1OdE9KeYVdWGLULjnL/46hsLSPXYnShDoDadznu849f1QdqbqjTv2/7zOtQXB2nhmrf1VqdW+kgQz0nPg5uLm0Bs6bf8vMShTVPYCGPqVc5Jd8bHB2jWphpuYH4t2HHhdtrbFujC9f8sZXmgL3F5ftXqvOesnK4pPCCEGgJFn3wAvnVVmLCQ9XXbTYSheF2ELjWZ44uFTGO2l9jnDxIIOQ82XDk/w/QN9aA/5YTkzHis8lOgJ74mGuULAa50Rml2CpVEUwAAmWGFQJ+XDkIF9vrQey8Gsq8iWITIAxC+fjTpJgDs+u+KeJ3H/fAD8+vbQeSacg4EuNAcpJg1bS94JtbhalkuQTq6Vgwl8Zirn9LtJXtysrWU9A75gIMwr4ad0gNxwjR6+CJyxWBQqLqKH5gZvVxH3E/7HE/uhPTLuHfTnrXlmcpZSnboAcsJdqNl8MajcH3LZaPx6a671xCLflnzh05FNag/7GpkkmmbyIkqoLnMrmt5UJbYSH+7ESjAuyvowmHlw7G4o6hluW6ehSW8x56Pis3FFcHDEdt3qXMQ8RwcY4GWkoJgqqIP3mn+Pz9qELUCUwmwEtpnsvD9dHku2+Z52MeuN4ygYxhK/M2UCZD0DvM7IHSxfvaZlaDfdehj//sjdp1O9DCwCa/kN5vx+olUpoxwlHbXGKaKQQfem3eoU0IB27AFSiDBbT1BENd1jPwcHsL1UNTd2w44v7R8bixvg/I4ZYHwhGvJaDpcwMPmBQKvPsTge3Fe8lBljfsc5v1mc9qFfNKnyRecLnpfnr2dZcNPKziePKDvAuXe/H1kAFba85G/Dq19hGA/A4rXyqflVHluf0ZRbK720ScLce4uA1UMAmXQoWNF8I16lPxlg+zKcPYn/gAAgy+lED2LD5xISiFvvOQoH3i4itMHorll2S9aPrl6ucxyrymSz0jjANJAxIu/nmVwG6srHsxap4kgW+tlSC6SW7CEDN36aXeVUrdudo31qKxoEZkq5Ei6zt+TWL6t/wgFdGr+q7K11KFlWH2tWAKzQNisXPbDSkM8HCJF
  template:
    metadata:
      labels:
        app: {{ drone.name }}-secrets
      name: github-ssh-keys
      namespace: {{ drone.namespace }}
    type: Opaque

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: harbor-registry-{{ drone.name }}-password
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    harbor-robot-password: AgAtzDwpbwnSpJjEkNsPg2nqC++cLuYDvidBlzI99QG+WF0pqKyqudAUFeY+rEPPSsoBmXurAJ10ON42A2OzkDl2PFkVGCi6i8AsXh3Hc8zMN4Q2crWCkVSheDTFok1e1rCQxpE93ljwU0XW3s5/2Zhfb5FRh2Nt+2YuGOBD1rvtTMSTE/jxTyqZu2gi0vQt2nal2jk0nDGQ7J14S4qtuSocCeelHNfDABbh9KPJ+uiuRRpMqrmdF1/aaTjVXJ0KEd/Rp3fg2SW80fsHIBIStFtr6WaV50vumaPRs+SKBMfD9nEnh2D8RIVV8Vnlk86mj4mtY6mJUGIf2+tkofhuE1dS1Oea1l+qUUHslP8MNkCO3uCcRHRhbRBMXSp5uT7YL6kYSXHHu6XPEl+BKp3S2IMmt3HKMmbmQWo2vE7lutbRG+TCGHZMkxRgRlX0cnfAhp9ASsfAMuWPTWr3lj+qp9uschl3SuXs4Z0iDw1g82hDwO+1nwMQseEzy6YiOIxudnJObznATKJ9XgQfbC2l48hOf1sbo1FDOtfoBiMnbJLkXhfegAB2MvZi08xowv8wOqVOMqSBR1RpKZxvxyDG4kqazv+BR6psxTDvwnN7vqSnxBJ2Kz4h76LbTyNxqcrcLmG7G8uy58uvj3HQrQ2potqsBvbGXgBBvlAEuAmPlZdZAQzeb5A0+jU6tOIlTsygMuum7Rg3x4xNOEcrMek1AXItC3K9QG6bDW9vy/Y5ViRv4A==
  template:
    metadata:
      labels:
        app: {{ drone.name }}-secrets
      name: harbor-registry-{{ drone.name }}-password
      namespace: {{ drone.namespace }}
    type: Opaque

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: slack-webhook-url
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    url: AgDd/2A/JxEUEDegN4OvpaILznBSNztWA1wUPftTmAHMVMy23ib+SqDOlhC2odM6/c8HyP0+Gz9SO9S6pTXWvkz5DkufSTTjns8Gukj0ejnVue7Jk7qbYaTKjPlodz+OuH5xC4a0kO8Hc8RVHc+JkpKMR+p1qo4DaU8QkropyEF3ARr6z9Pni1J1v8psD/XyCtNx/JPToKvHLLlVfPq6J0+nrKQ/76YEGDBTLnbpToMERG/rr614m05aivVXX1/zRwkCrvTH0F5Ue6EfEY0c1PXKWfWUhfWlE3vBuAP8QEXnO8WeMNtheS2/Jif+n2sbK928IX/hl3QiotFEoJJXWtp8IzN21SEesRruTIUOHD6rFsrPKIWQMuXZE8s3tP/N8bB5ES5MzzN26bo/ScuR/i0ob4lPa8LOrqzsO8VsiE32AxpDLKULyvje/K9cVlSaK1RiAPfOgtaSApppI89gnOrQ4brHvXrCZU+Z+y7DQwWDu1qbL+gnvq1gLxMnTnmDPi5hV/MD0YBir09H5mPyrjCBp/6Q9ogboF5m3xTNBT8gRfDXyOB3ghEP9U90cpsv/IrEQdB1khxpwHa6qmBW8LucPYeidk9fOXBczsXYkJUSPzkjZNnUyYFIELAqV3qffDQBkszlmvziMN/wZAjSWd0sujL675GCptMo0TdF4GzcXUoqJdQzJHhmykpF2Y7MrUH8Y2CZEvkf8kZQ9+yzkOcl9y9VooI9tJKWvRePX8OLZWsIqfquYYeqMW3b0siHMHqw1hi9II7FNvBARVQaDGkRhbkZBI6Jattu/cxKPwMdcHI=
  template:
    metadata:
      labels:
        app: {{ drone.name }}
      name: slack-webhook-url
      namespace: {{ drone.namespace }}
    type: Opaque

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: {{ drone.name }}-server-secret
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    DRONE_RPC_SECRET: AgDq+9cab6eGpDwohvcqG18BsXmQmoQnTdG+7tUBCY3QU+D7V3B4jYaV3CSvuBMUdXl0r8Y6Ujc9GyUswSAzR7slLhtlqZzeh2Pe9bJbQL86b7ta376hKMMnupxFVfcEYvoszV0BoY4eiKqVOsG2xYuJYw83nJFY8HUq81NlXbnPeXLN2xA55XPQeH2IPuTlpbwF9BdipkLVTRha+ALSvWhZKaMStgXhognn8r+kyEKCaK4J7y+PtwzHKWtZPLcQslw+sorxtUlPkuGnFvnoPeYGW5cm9OSf+Rz75FyE8Xnffg6ScYym2PBGrm7A9/mj5jlOJRRuhRINtt3zSs3R28+NSmlwIMKSyNHthV7Fo/SUKNheBK/K+xkC/5dEWoOeHHC91bjKC4FZr8sKhH8z16bF/72LABASNZ8g1vt7lxCu8OCHsL03xzffSMGX0/zdcwLxvNeUTZzx4QH8SA0T91EjDhcCL6nZDMB8yXdyeQq86IQgq9WLENdy4xdzPOxRLZLlSCHCOvXb6h0aLgmO+coC/WtNtZ9mx+FIhxXX7f+/Srez0boxt5AZz5u1F1Yliez99NaN0njnWBQ41Wi+YCXBW7mHe9Sf4RAlYgGZ/FyVU7Iz5d4otSGDR+qlUx17oJ5cC2shVn9SxlWinpBl3tggWI0wzxY604uYqHfAJV7FcjMGjVGpQsOE+DaYyIO9nXvH99qH0fm1bvUT337OPf0+0ppWmufQ5ORhMO8f3CybiA==
    DRONE_GITHUB_CLIENT_ID: AgCYM7K6a+KrooUE1Zcf0MG8KhnWaZEg5H2+Zfp4MC/TyGxUkco4++fu/iwoIvmanYrCb+vppOfUrgGuTFWNj0n7+uEYk5uiNXsZLUAtoKClmDGrzwrxIeTfC3/sG3r84Kn8u3INXR2xSSevi0sbRAoOTtFn+G4K0B+iyZgND7MsbYupihnjTpzk+gDT5ROQwkL++RQrqcsTXLcNHnR+UJOojDL+HD/KiLbbR8LTwsEtB7JCtc94wj9rj0O6x/KuW1fIy5IL3BLMpviPtad6+uXChLi3/+dSqa6PWUPx1nO0k+8UYK1J8HHU5O3qVgMxxrNlT7HJq839aWb5xzTUk3G/Wi/Rr/vn4h+9+tEvAorwRxurX3yMkO6Yyfa1uJyif4fwT/gDAMMDj+SyzK3jn5FOPddc/aTjv/HHueQrWo9ErKPUOjKW7o/ril7OCXJ9dCfXGG7wTu7mJaBMrJdjOgAcm0OW/hEts6k7s+E5KH32zgkd7HPixIJuYpnNfPHbpeo5v5DPYOpveY5kv/NGRkZwmN5IlwP1buHBsSX4NYhJTcRLRRaXH05BKJtbgbvGzRaVGl5ThxmA/lERrCKWPqX9G3hi6w/fjZlW10CzbDAsDcqiiJJ7c1SybqknGMFH9oFR9+ukOKge2YJTrE1D33xv6cLogriLgZojKUVVES+O85KAzUXWszJNAzzdM6EMwz/IwbHLIvj3P4/LW/73vRef6uqNhw==
    DRONE_GITHUB_CLIENT_SECRET: AgC6ehEAnvaMNs+Uews1hzhGMHMbE7lX+5qX7fADpK8nebUBHq2HWU5uNCY7hV9OEdTQiFDujyGeYyULpI2kdnBZZ495NkxjcOo0VRMP2wxQIpBAzQ64o010a7nHlByOeebSxddqNdzTKBIdCIU5y/QaorQN4ozRdsaxQA9Bu49FRLgPRcxdjaVtwCnbHIPTTqi3mxOTCRDlddpuE9ZFtK36HYe/GKjgI7VRg3wqSIK3dOLzTgDvEpswRI94ofHAdOzqOkyaPaBPyXQNp0z/C8QtfkH8+/ZBk7hvzclPi+ztQ9ays/wYzeWog1sUAlUtvjqFCvHFrkr0K34HVfOqPWRzH/8GWl3quT0cXw4FcfawqiVphe6CXhGdOQAexNXVbsCyoY14/LoyRmgZL6BmTW4ZJCVlbDmtfPfVY95JTI55oWpks6EXfEcuprucd3RWUTikZFkDmizcbNDbJjAG3uTv+lyCft1jGnJDxnVmiEFOJV8WygMP7q6NAdsyNr8beDIK3zNXSWfxybGz4SXcliFnS49sfGffL8G+E523tUD2UC6h6BHa1uMaYrEVWfnxN3AUymhfj9wJAOnIXA5GCcmlyYr84wlStep/KfWqrv+hS6yRJKyPNBsItUpFKtdLl8IG3EqDLhVzTsHBYHbq/AdZFxd5ImXeGzfTKKIBkHHlFd7kMxBZSsf+W34/LH0QRivg9VQqVcgw4qhFH/Qup74KjlsUmnOYLoK/2d/dRo9wdzbEIgucC+qz
  template:
    metadata:
      name: {{ drone.name }}-server-secret
      namespace: {{ drone.namespace }}
      labels:
        app: {{ drone.name }}-server

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: {{ drone.name }}-runner-docker-secret
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    DRONE_RPC_SECRET: AgBe3nUv7MqFe9ag9qVPOMd7uDGGrDRVboW4B2askpSbiNVYn6AmsEI6vHE+H2pjtJOsD+ohTthMz+9+PP0lVxEVTXkmIJm7J34dyQ2bbwOxT0GOm0bE2MDjmgUmMksN7ESLJ7pXFbHaUq53/OUspLHdy5EO/gjXGkprDDLSezSdYxIa7wOzO8bvWV8851GaxeT1ZFz7XL/8UDAY/XmNteEFHprvO/hdBrhyhWt1bQrnSLOQEahCWlAvtwtZuC0yxA5ngxbWq/ko4jiC26oVBaw7y/dzm1YGF42tsPgia7kQQEIWfR9+ZHC4tfyFFPt21SdBdXaodmR6Lw4SSW2XEcvKMSRiltaW5TgiaoRGWZWwThTejQ4NfPFn9yYaOIjyLqxqybiilPJDUJn5NltYGh6vAJRFnBZml2/C6VL8b8JX6giogoxJt+iBdGyrhYLTJu1NAwAUStHRP2p+WT98nAhqddQmcgRuXlqFtMTTB/vNBuLnLDBYDjV/IKo7jgWDJiRkhJB+ob64pDAWw+oN9pYJ47Fx2aQx7jnErKur84kCNMkFG+E1nepofKbMcxDs4+A0gPQ62JJRL3p3EsFjTcrZN6XYPq+327sk2nZyEUdIltYg1x76bN4+rN3bDNKBfOELacyj0LVWEST5X/Vs65ra0uKOxBbDFk2nPBjYubEEOZ1JsF+RxkZnH81FyDuabZEodG7Pkmd7EqH7B6rXf2cVr2zsWAaCUBO9jFe+0XaYMw==
    DRONE_SECRET_PLUGIN_TOKEN: AgBoqEqneK39Nk6GJk6stzL23cJgOR0hMkZ2xErO30sfkc5vM4oVJlsUO+n7d13IYq5uwtOYCufve+WyqBAy/FL7/XUAASDa7CKRVlcNFKy8IiDsD7qDo2R0rF+QkS99d8SKRLc6WrL8WmalENOGBdXMQsIt/GW1D9/uEyQfqFqRr+dpTXAiowwtkUxEOgjtGLeZEYjRhELcbjOiirVOS+BfNA11I2IezMWeO2XKyKfkzC2tBzInbZCZMPKc/fxZiy3LBJTMFMRB6bPd0Xg8Pnlb3rztH9js+Ys+HHAH3ZFOCRKXWFG3jzHrctZfp0Z/9XU7Fh3y5oAmcD8u9Ip10TrHi6fBkRkQN49hbdM5KTwd3XwCPQn+0sfMUQtHE8m8g6W6ubPtAEbww4YAwtPpAY4+Wd2Wid4WxyY4RB2CGfZKVK2MTX/y3oShlto2iasNAOCQG8mCiJIDnGbu6NBx7KAHfckBwqninHgNQuCRLtDgWem69EkkqXmysSfZqdBdSjujfhLIoqEkpk6QdZwqHi4U7W4h4zDfmg5Xfnc2+XPOdzL1rTYElbIn5cMlPRWf5OYfgH7rsFIzDdNHU4EaqrLk0OeJa6Q4d8kBBtv1CGGwyB6wTELp4oFfpZhGWyQA4zEivj8dcw5NNUWL8z9oij0Z2NKmmtY8VWG94JquSdjl1KjsVxH3e12YDDHmEf22sU3imej3joqnKd02D2bSvqXPxjgYfQhTsw/esBRmM0pS8g==
  template:
    metadata:
      name: {{ drone.name }}-runner-docker-secret
      namespace: {{ drone.namespace }}
      labels:
        app: {{ drone.name }}-runner-docker

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: {{ drone.name }}-secrets-secret
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    SECRET_KEY: AgAD/OhJL7TEd0OhAck+M4d+F5Ss6/SLRHQlsIQa1EBR+9AQbQx9qeiNmgq8ccFze8PVUqvVz2MYweB3UdkXCL8HHVbQOzyJXWUg9RrykvNFMJ/oOPABFT4fd6RmsJQDxwgv0z1WX3uhoIdU3O1DmCtQ21gcPgdXpfKo/w8sNTYxQXt7Cb8XbtTwgvgsFsnPS4yq6yDBk27VOMpZ4fLKf4SeNoa7wlAXS9bQWDWktnwB2jd6cdAMwkNfjuEZ8FlU+XGcvuxEkVPvkxHqSkCagNy1hNmX2Xd6QpNUhqftBGtdrRwumzQldDxdB/3iDP7Ujzocs/x5TpcPgLAs/DRcC9pEP6C58eXSOi6lqIojN/KFzm6R/3WrWLrZ2R4YOQlDvaGjBHjH/tPd4t+udxWbwt2dQhCEDdywkdS0klnfl374H7dgXnXk7bETATaVP3uBgATI+4UjnGoO1WFTsoNqmc/sWdcriPeiROHRs9HAKgkCz3T44dO6Uh9LrVujT1Sdg5KGSvlm2lt1vfIu5ie+KYdN/1p9SSdxBnA3osO3zjKrBMeh3ju8XLzBuYexHgzL4gMakOpe3q+xKrCAPOy6rOGrGE5bSOwJkHPdtBP2wkgso3bxMsHfzjp7HuUhvjnWw9+GZnv8WFbCGaZjAXEwgoMJjKPNjvNpx5gwZMNyJJxq/PPHmU9ZQDjUHv8/ft8tzJhpOOZn9sGaReqe4GL+F6AkwkhafCHUMTRad0WmrAVbEA==
  template:
    metadata:
      name: {{ drone.name }}-secrets-secret
      namespace: {{ drone.namespace }}
      labels:
        app: {{ drone.name }}-secrets

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: {{ drone.name }}-personal-token
  namespace: {{ drone.namespace }}
spec:
  encryptedData:
    DRONE_PERSONAL_TOKEN: AgAkefUWBGYaC58coQBref25tRmTFOTx6jbik+8OJ2xt4i9bL4e3b/O3NtTXjmFpA0lCYOzhc27vx+H2xeJu2MMLQyXdpZXhFo3g+1JG5mGckKG1L8RW28wYsrBZrhOHEDTQvb0aRf/wPcVwxGKCP/Q1IDf2aG94kR1nE0BmBe7zAhQ8X2oDS21R4F0qKWnlP+MPcJg1yFYuzk5wWySvgXZblq+YFw9R6qmSspnFbGju3iSJHRS1kp8Q70MYK2DFyOW4jG3FwgA6+hKFGRWlS9Fnzk1B8mHhU61QVXBsiTnsDi7wBrrgjzozRK1flhVwh1OwbrQ/JzYT5cCYRIoDDvIQ2Yp6njklRg53ZFgUSFokgWcTpiNRsa3IsAsW0P+8jMoiUY2tRQQl3plQxUK7jhwhHZuTWEQE9fFPnOk61pGOMG3OItQAIzgVcS5kyL9WhpzfitHA8PhcDCT9JWUgn93Al+8mvqqnWtp/slE1HcnK+BPpiycEXfKpcFQinS7yUf/eSVS1rn/qU0nLkXTEiDyCynbgeleoUfN5qi0Ua4Q+WRC4+rpRGJfqelEX6PSSuy/FF9rxcTkHhBt4PykGPUiED9wg5HTxc/IXfS6CS/cbJGzTOBlbaeQMej52cHm9qGUXBq0LiM3PyD8f9iXbB+XZU4ggkb3LyJrS+5G1qr4OVT4+LOeTFFFdL+0Do/StNGSNA4PXnDPzQqVIibXmNzGkTJ3pn6MAn2iP22/KNSkB8Q==
  template:
    metadata:
      labels:
        app: {{ drone.name }}
      name: {{ drone.name }}-personal-token
      namespace: {{ drone.namespace }}
    type: Opaque

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ drone.name }}-server-config
  namespace: {{ drone.namespace }}
data:
  DRONE_SERVER_HOST: "drone.theautomation.nl"
  DRONE_SERVER_PROTO: "https"
  DRONE_USER_FILTER: "theautomation"
  DRONE_TLS_AUTOCERT: "false"
  DRONE_LOGS_TRACE: "true"
  # DRONE_DATABASE_DRIVER=postgres
  # DRONE_DATABASE_DATASOURCE=postgres://root:password@1.2.3.4:5432/postgres?sslmode=disable

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ drone.name }}-runner-docker-config
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-runner-docker
data:
  DOCKER_HOST: "tcp://localhost:2375"
  DRONE_RPC_HOST: "{{ drone.name }}-server-svc.{{ drone.namespace }}.svc.cluster.local:8080"
  DRONE_RPC_PROTO: "http"
  DRONE_RPC_SKIP_VERIFY: "true"
  DRONE_LOGS_TRACE: "true"
  DRONE_DEBUG: "true"
  DRONE_NAMESPACE_DEFAULT: "{{ drone.namespace }}"
  DRONE_SECRET_PLUGIN_ENDPOINT: "http://{{ drone.name }}-secrets.{{ drone.namespace }}.svc.cluster.local:3000"

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ drone.name }}-secrets-config
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-runner-kube
data:
  KUBERNETES_NAMESPACE: "{{ drone.namespace }}"
  DRONE_DEBUG: "true"

---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: {{ drone.name }}-server
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-server

---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: {{ drone.name }}-runner-docker
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-runner-docker

---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: {{ drone.name }}-secrets
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-secrets

---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: {{ drone.name }}-secrets
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-secrets
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - get
      - watch

---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: {{ drone.name }}-secrets
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-secrets
subjects:
  - kind: ServiceAccount
    name: {{ drone.name }}-secrets
    namespace: {{ drone.namespace }}
roleRef:
  kind: Role
  name: {{ drone.name }}-secrets
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ drone.name }}-server
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ drone.name }}-server
  template:
    metadata:
      labels:
        app: {{ drone.name }}-server
    spec:
      automountServiceAccountToken: false
      serviceAccountName: {{ drone.name }}-server
      containers:
        - name: {{ drone.name }}-server
          image: "drone/drone:{{ drone.image_tag.server }}"
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          env:
            - name: DRONE_PERSONAL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ drone.name }}-personal-token
                  key: DRONE_PERSONAL_TOKEN
                  optional: true
            - name: DRONE_SERVER_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ drone.name }}-personal-token
                  key: DRONE_PERSONAL_TOKEN
                  optional: true
            - name: DRONE_USER_CREATE
              value: "username:theautomation,admin:true,token:$(DRONE_PERSONAL_TOKEN)"
          envFrom:
            - configMapRef:
                name: {{ drone.name }}-server-config
            - secretRef:
                name: {{ drone.name }}-server-secret
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
          volumeMounts:
            - name: {{ drone.name }}-server-data
              mountPath: /data
              subPath: ""
          resources: {}
      volumes:
        - name: {{ drone.name }}-server-data
          persistentVolumeClaim:
            claimName: pvc-iscsi-{{ drone.name }}-server-data

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: {{ drone.name }}-runner-docker
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-runner-docker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ drone.name }}-runner-docker
  template:
    metadata:
      labels:
        app: {{ drone.name }}-runner-docker
    spec:
      serviceAccountName: {{ drone.name }}-runner-docker
      containers:
        - name: {{ drone.name }}-runner-docker
          image: "drone/drone-runner-docker:{{ drone.image_tag.runner_docker }}"
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: {{ drone.name }}-runner-docker-config
            - secretRef:
                name: {{ drone.name }}-runner-docker-secret
          env:
            - name: DOCKER_HOST
              value: tcp://localhost:2375
            - name: DRONE_RUNNER_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - name: tcp
              containerPort: 3000
              protocol: TCP
          livenessProbe:
            tcpSocket:
              port: tcp
          readinessProbe:
            tcpSocket:
              port: tcp
          resources: {}
        - name: dind
          image: docker:{{ drone.image_tag.dind }}
          imagePullPolicy: IfNotPresent
          command:
            - dockerd
          args:
            - --host
            - tcp://localhost:2375
          securityContext:
            privileged: true
          livenessProbe:
            exec:
              command:
                - docker
                - -H
                - tcp://localhost:2375
                - images
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - docker
                - -H
                - tcp://localhost:2375
                - images
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
            - mountPath: /var/lib/docker
              name: storage
              subPath: docker
            - name: daemon-json
              mountPath: /etc/docker/daemon.json
              subPath: daemon.json
            - name: kubeconfig
              mountPath: /var/lib/.kube/config
              subPath: config
          resources: {}
        - name: gc
          image: "drone/gc:{{ drone.image_tag.gc }}"
          imagePullPolicy: IfNotPresent
          env:
            - name: DOCKER_HOST
              value: tcp://localhost:2375
            - name: GC_CACHE
              value: "5gb"
            - name: GC_DEBUG
              value: "false"
            - name: GC_DEBUG_COLOR
              value: "false"
            - name: GC_DEBUG_PRETTY
              value: "false"
            - name: GC_IGNORE_CONTAINERS
              value: ""
            - name: GC_IGNORE_IMAGES
              value: ""
            - name: GC_INTERVAL
              value: "5m"
          resources: {}
      volumes:
        - name: daemon-json
          configMap:
            name: docker-deamon-json
        - name: kubeconfig
          secret:
            secretName: kubeconfig
        - emptyDir: {}
          name: storage

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: {{ drone.name }}-secrets
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-secrets
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ drone.name }}-secrets
  template:
    metadata:
      labels:
        app: {{ drone.name }}-secrets
    spec:
      serviceAccountName: {{ drone.name }}-secrets
      containers:
        - name: {{ drone.name }}-secrets
          image: "drone/kubernetes-secrets:{{ drone.image_tag.kubernetes_secrets }}"
          resources: {}
          ports:
            - containerPort: 3000
              protocol: TCP
          envFrom:
            - configMapRef:
                name: {{ drone.name }}-secrets-config
            - secretRef:
                name: {{ drone.name }}-secrets-secret

---
kind: Job
apiVersion: batch/v1
metadata:
  name: {{ drone.name }}-add-cron
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-add-cron
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: {{ drone.name }}-add-cron
          image: "harbor.k8s.lan/k8s/drone-cli:latest"
          imagePullPolicy: Always
          resources: {}
          command: ["/bin/bash", "-c"]
          args: [
              "IFS=','; curl -sf -m 5 ${DRONE_SERVER}/healthz | grep 'OK' && sleep 3 || exit 10; \
              for r in ${REPOS}; do command=$(drone cron add --branch ${DEFAULT_BRANCH} ${ORGANIZATION}/${r} schedule-from-job ${SCHEDULE} 2>&1); \
              if grep -q 'UNIQUE' <<<$command; then echo 'Cron for '${r}' has already been set'; elif grep -q 'no such host' <<<$command; \
              then echo 'No connection to host' && sleep 3 && exit 10; else echo 'Added cron for' ${r}; fi; done",
            ]
          env:
            - name: DRONE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ drone.name }}-personal-token
                  key: DRONE_PERSONAL_TOKEN
                  optional: false
            - name: DRONE_SERVER
              value: "http://{{ drone.name }}-server-svc.{{ drone.namespace }}.svc.cluster.local:8080"
            - name: ORGANIZATION
              value: "theautomation"
            - name: REPOS
              value: "drone-cli,bitwarden-cli-init,node-red,esphome,protonmail-bridge"
            - name: SCHEDULE
              value: "* 0 1 * * 5"
            - name: DEFAULT_BRANCH
              value: "main"
      imagePullSecrets:
        - name: harbor-registry-creds

---
kind: Service
apiVersion: v1
metadata:
  name: {{ drone.name }}-server-svc
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-server
spec:
  selector:
    app: {{ drone.name }}-server
  type: ClusterIP
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 80

---
kind: Service
apiVersion: v1
metadata:
  name: {{ drone.name }}-runner-docker
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-runner-docker
spec:
  type: ClusterIP
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: http
  selector:
    app: {{ drone.name }}-runner-docker

---
kind: Service
apiVersion: v1
metadata:
  name: {{ drone.name }}-secrets
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-secrets
spec:
  selector:
    app: {{ drone.name }}-secrets
  type: ClusterIP
  ports:
    - name: http
      protocol: TCP
      port: 3000
      targetPort: 3000

---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ drone.name }}-server
  namespace: {{ drone.namespace }}
  labels:
    app: {{ drone.name }}-server
spec:
  ingressClassName: nginx-public
  rules:
    - host: "drone.theautomation.nl"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ drone.name }}-server-svc
                port:
                  number: 8080
  tls:
    - hosts:
        - drone.theautomation.nl
      secretName: tls-wildcard-theautomation-nl
